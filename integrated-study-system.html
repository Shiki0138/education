<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼¢å­—ãƒã‚¹ã‚¿ãƒ¼ - è¿½æ‰‹é–€å­¦é™¢ä¸­å­¦å…¥è©¦å¯¾ç­–</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #333;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            color: #2c3e50;
            font-size: 2em;
        }
        
        .study-area {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .question-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .question-number {
            font-size: 1.2em;
            color: #7f8c8d;
        }
        
        .question-level {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .level-1 { background: #3498db; color: white; }
        .level-2 { background: #2ecc71; color: white; }
        .level-3 { background: #f39c12; color: white; }
        .level-4 { background: #e74c3c; color: white; }
        
        .question-text {
            font-size: 1.5em;
            line-height: 1.8;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .question-text .highlight {
            background: #fff3cd;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            border-bottom: 3px solid #f39c12;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }
        
        .option-button {
            padding: 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-button:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .option-button.selected {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .option-button.correct {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }
        
        .option-button.incorrect {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        
        .submit-button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }
        
        .submit-button:hover {
            background: #2980b9;
        }
        
        .submit-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .feedback-section {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .feedback-section.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .feedback-section.incorrect {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .progress-sidebar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }
        
        .progress-item {
            margin-bottom: 20px;
        }
        
        .progress-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .progress-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .mini-progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .mini-progress-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s;
        }
        
        .start-button {
            width: 100%;
            padding: 20px;
            font-size: 1.3em;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 30px;
        }
        
        .start-button:hover {
            background: #27ae60;
        }
        
        @media (max-width: 768px) {
            .study-area {
                grid-template-columns: 1fr;
            }
            
            .progress-sidebar {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>ğŸ“š æ¼¢å­—ãƒã‚¹ã‚¿ãƒ¼ è¿½æ‰‹é–€å­¦é™¢ä¸­å­¦å…¥è©¦å¯¾ç­–</h1>
            <p>æ¯æ—¥10å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã€5æ—¥ã§100å††ã‚’ã‚²ãƒƒãƒˆã—ã‚ˆã†ï¼</p>
        </div>
        
        <div class="study-area">
            <div class="question-section" id="questionSection" style="display:none;">
                <div class="question-header">
                    <span class="question-number" id="questionNumber">å•é¡Œ 1/10</span>
                    <span class="question-level" id="questionLevel">ãƒ¬ãƒ™ãƒ«1</span>
                </div>
                
                <div class="question-text" id="questionText">
                    <!-- å•é¡Œæ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                <div class="options-grid" id="optionsGrid">
                    <!-- é¸æŠè‚¢ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                <button class="submit-button" id="submitButton" disabled>ç­”ãˆã‚’ç¢ºèª</button>
                
                <div class="feedback-section" id="feedbackSection">
                    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
            
            <div class="welcome-section" id="welcomeSection">
                <div class="question-section">
                    <h2>ä»Šæ—¥ã®å­¦ç¿’ã‚’å§‹ã‚ã‚ˆã†ï¼</h2>
                    <p>è¿½æ‰‹é–€å­¦é™¢ä¸­å­¦ã®å…¥è©¦ã«å‡ºã‚‹æ¼¢å­—ã‚’ã€æ¥½ã—ãå­¦ç¿’ã§ãã¾ã™ã€‚</p>
                    <ul>
                        <li>æ¯æ—¥10å•ã®æ¼¢å­—å•é¡Œã«æŒ‘æˆ¦</li>
                        <li>6å•ä»¥ä¸Šæ­£è§£ã§åŸºæœ¬ãƒã‚¤ãƒ³ãƒˆã‚²ãƒƒãƒˆ</li>
                        <li>æº€ç‚¹ãªã‚‰æœ€å¤§20ãƒã‚¤ãƒ³ãƒˆç²å¾—</li>
                        <li>5æ—¥é€£ç¶šã§100å††é”æˆï¼</li>
                    </ul>
                    <button class="start-button" id="startButton">å­¦ç¿’ã‚’å§‹ã‚ã‚‹</button>
                </div>
            </div>
            
            <div class="progress-sidebar">
                <h3>ä»Šæ—¥ã®é€²æ—</h3>
                
                <div class="progress-item">
                    <div class="progress-label">å®Œäº†ã—ãŸå•é¡Œ</div>
                    <div class="progress-value" id="completedCount">0/10</div>
                    <div class="mini-progress-bar">
                        <div class="mini-progress-fill" id="questionProgress" style="width:0%"></div>
                    </div>
                </div>
                
                <div class="progress-item">
                    <div class="progress-label">æ­£è§£æ•°</div>
                    <div class="progress-value" id="correctCount">0å•</div>
                </div>
                
                <div class="progress-item">
                    <div class="progress-label">ä»Šæ—¥ã®ç²å¾—äºˆå®š</div>
                    <div class="progress-value" id="expectedPoints">0P</div>
                </div>
                
                <div id="miniRewardStatus"></div>
            </div>
        </div>
        
        <div id="reward-system-container">
            <!-- å ±é…¬ã‚·ã‚¹ãƒ†ãƒ UIãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
    </div>
    
    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="large-kanji-database.js"></script>
    <script src="option-validator.js"></script>
    <script src="reward-system.js"></script>
    <script src="reward-ui.js"></script>
    
    <script>
        // çµ±åˆå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
        class IntegratedStudySystem {
            constructor() {
                this.problemEngine = new DynamicProblemEngine();
                this.optionValidator = new OptionValidator();
                this.rewardSystem = new KanjiRewardSystem();
                this.rewardUI = new RewardSystemUI(this.rewardSystem);
                
                this.currentProblems = [];
                this.currentProblemIndex = 0;
                this.sessionResults = [];
                this.selectedOptionIndex = null;
                
                this.initializeSystem();
            }
            
            initializeSystem() {
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                document.getElementById('startButton').addEventListener('click', () => this.startSession());
                document.getElementById('submitButton').addEventListener('click', () => this.submitAnswer());
                
                // å ±é…¬ã‚·ã‚¹ãƒ†ãƒ UIæ›´æ–°
                this.rewardUI.updateDisplay();
                
                // ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ‡ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (this.rewardSystem.checkSurpriseDay()) {
                    alert('ğŸ‰ ä»Šæ—¥ã¯ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ‡ãƒ¼ï¼ãƒã‚¤ãƒ³ãƒˆ2å€ã®ãƒãƒ£ãƒ³ã‚¹ï¼');
                }
            }
            
            startSession() {
                // ä»Šæ—¥ã®å•é¡Œã‚’ç”Ÿæˆ
                const today = new Date();
                this.currentProblems = this.problemEngine.generateDailyUniqueProblems(today);
                this.currentProblemIndex = 0;
                this.sessionResults = [];
                this.selectedOptionIndex = null;
                
                // UIåˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('welcomeSection').style.display = 'none';
                document.getElementById('questionSection').style.display = 'block';
                
                // æœ€åˆã®å•é¡Œã‚’è¡¨ç¤º
                this.displayProblem();
            }
            
            displayProblem() {
                const problem = this.currentProblems[this.currentProblemIndex];
                
                // å•é¡Œç•ªå·æ›´æ–°
                document.getElementById('questionNumber').textContent = 
                    `å•é¡Œ ${this.currentProblemIndex + 1}/10`;
                
                // ãƒ¬ãƒ™ãƒ«è¡¨ç¤º
                const levelElement = document.getElementById('questionLevel');
                levelElement.textContent = `ãƒ¬ãƒ™ãƒ«${problem.level}`;
                levelElement.className = `question-level level-${problem.level}`;
                
                // å•é¡Œæ–‡è¡¨ç¤ºï¼ˆæ¼¢å­—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
                const questionText = problem.question.replace(
                    /ã€Œ(.+?)ã€/g, 
                    '<span class="highlight">$1</span>'
                );
                document.getElementById('questionText').innerHTML = questionText;
                
                // é¸æŠè‚¢ã‚’æ¤œè¨¼ã—ã¦è¡¨ç¤º
                const validatedOptions = this.optionValidator.validateOptions(
                    problem.options,
                    problem.correct
                );
                
                // é¸æŠè‚¢ãƒœã‚¿ãƒ³ä½œæˆ
                const optionsGrid = document.getElementById('optionsGrid');
                optionsGrid.innerHTML = '';
                
                validatedOptions.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option;
                    button.addEventListener('click', () => this.selectOption(index));
                    optionsGrid.appendChild(button);
                });
                
                // UIãƒªã‚»ãƒƒãƒˆ
                document.getElementById('submitButton').disabled = true;
                document.getElementById('feedbackSection').style.display = 'none';
                this.selectedOptionIndex = null;
            }
            
            selectOption(index) {
                // å‰ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // æ–°ã—ã„é¸æŠ
                document.querySelectorAll('.option-button')[index].classList.add('selected');
                this.selectedOptionIndex = index;
                document.getElementById('submitButton').disabled = false;
            }
            
            submitAnswer() {
                if (this.selectedOptionIndex === null) return;
                
                const problem = this.currentProblems[this.currentProblemIndex];
                const isCorrect = this.selectedOptionIndex === problem.correct;
                
                // çµæœã‚’è¨˜éŒ²
                this.sessionResults.push({
                    problemIndex: this.currentProblemIndex,
                    isCorrect: isCorrect,
                    kanjiWord: problem.kanjiWord,
                    level: problem.level
                });
                
                // é¸æŠè‚¢ã®è‰²ã‚’å¤‰æ›´
                const buttons = document.querySelectorAll('.option-button');
                buttons[this.selectedOptionIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
                buttons[problem.correct].classList.add('correct');
                
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
                const feedback = document.getElementById('feedbackSection');
                feedback.className = `feedback-section ${isCorrect ? 'correct' : 'incorrect'}`;
                feedback.innerHTML = `
                    <h3>${isCorrect ? 'ğŸ‰ æ­£è§£ï¼' : 'ğŸ˜¢ æ®‹å¿µ...'}</h3>
                    <p>${problem.explanation}</p>
                    ${problem.hint ? `<p>ãƒ’ãƒ³ãƒˆ: ${problem.hint}</p>` : ''}
                `;
                feedback.style.display = 'block';
                
                // é€²æ—æ›´æ–°
                this.updateProgress();
                
                // ãƒœã‚¿ãƒ³ã‚’å¤‰æ›´
                const submitButton = document.getElementById('submitButton');
                if (this.currentProblemIndex < 9) {
                    submitButton.textContent = 'æ¬¡ã®å•é¡Œã¸';
                    submitButton.onclick = () => this.nextProblem();
                } else {
                    submitButton.textContent = 'çµæœã‚’è¦‹ã‚‹';
                    submitButton.onclick = () => this.showResults();
                }
                submitButton.disabled = false;
            }
            
            nextProblem() {
                this.currentProblemIndex++;
                this.displayProblem();
                document.getElementById('submitButton').textContent = 'ç­”ãˆã‚’ç¢ºèª';
                document.getElementById('submitButton').onclick = () => this.submitAnswer();
            }
            
            showResults() {
                // æ­£è§£æ•°ã‚’è¨ˆç®—
                const correctCount = this.sessionResults.filter(r => r.isCorrect).length;
                
                // å ±é…¬ã‚·ã‚¹ãƒ†ãƒ ã«è¨˜éŒ²
                const result = this.rewardSystem.recordDailyResult(new Date(), correctCount);
                
                // çµæœè¡¨ç¤º
                this.rewardUI.displayTodayResult(result);
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
                this.endSession();
            }
            
            updateProgress() {
                const completed = this.currentProblemIndex + 1;
                const correct = this.sessionResults.filter(r => r.isCorrect).length;
                
                document.getElementById('completedCount').textContent = `${completed}/10`;
                document.getElementById('correctCount').textContent = `${correct}å•`;
                document.getElementById('questionProgress').style.width = `${completed * 10}%`;
                
                // äºˆæƒ³ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
                const currentRate = correct / completed;
                const expectedCorrect = Math.round(currentRate * 10);
                const expectedPoints = this.rewardSystem.calculateDailyPoints(expectedCorrect);
                document.getElementById('expectedPoints').textContent = `${expectedPoints}P`;
            }
            
            endSession() {
                // UIã‚’ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    document.getElementById('questionSection').style.display = 'none';
                    document.getElementById('welcomeSection').style.display = 'block';
                    
                    // å ±é…¬ã‚·ã‚¹ãƒ†ãƒ UIæ›´æ–°
                    this.rewardUI.updateDisplay();
                }, 3000);
            }
        }
        
        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        const studySystem = new IntegratedStudySystem();
    </script>
</body>
</html>