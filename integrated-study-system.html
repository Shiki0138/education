<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漢字マスター - 追手門学院中学入試対策</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #333;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            color: #2c3e50;
            font-size: 2em;
        }
        
        .study-area {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .question-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .question-number {
            font-size: 1.2em;
            color: #7f8c8d;
        }
        
        .question-level {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .level-1 { background: #3498db; color: white; }
        .level-2 { background: #2ecc71; color: white; }
        .level-3 { background: #f39c12; color: white; }
        .level-4 { background: #e74c3c; color: white; }
        
        .question-text {
            font-size: 1.5em;
            line-height: 1.8;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .question-text .highlight {
            background: #fff3cd;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            border-bottom: 3px solid #f39c12;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }
        
        .option-button {
            padding: 20px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-button:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .option-button.selected {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .option-button.correct {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }
        
        .option-button.incorrect {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        
        .submit-button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }
        
        .submit-button:hover {
            background: #2980b9;
        }
        
        .submit-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .feedback-section {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .feedback-section.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .feedback-section.incorrect {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .progress-sidebar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }
        
        .progress-item {
            margin-bottom: 20px;
        }
        
        .progress-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .progress-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .mini-progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .mini-progress-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s;
        }
        
        .start-button {
            width: 100%;
            padding: 20px;
            font-size: 1.3em;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 30px;
        }
        
        .start-button:hover {
            background: #27ae60;
        }
        
        @media (max-width: 768px) {
            .study-area {
                grid-template-columns: 1fr;
            }
            
            .progress-sidebar {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>📚 漢字マスター 追手門学院中学入試対策</h1>
            <p>毎日10問チャレンジして、5日で100円をゲットしよう！</p>
        </div>
        
        <div class="study-area">
            <div class="question-section" id="questionSection" style="display:none;">
                <div class="question-header">
                    <span class="question-number" id="questionNumber">問題 1/10</span>
                    <span class="question-level" id="questionLevel">レベル1</span>
                </div>
                
                <div class="question-text" id="questionText">
                    <!-- 問題文がここに表示される -->
                </div>
                
                <div class="options-grid" id="optionsGrid">
                    <!-- 選択肢がここに表示される -->
                </div>
                
                <button class="submit-button" id="submitButton" disabled>答えを確認</button>
                
                <div class="feedback-section" id="feedbackSection">
                    <!-- フィードバックがここに表示される -->
                </div>
            </div>
            
            <div class="welcome-section" id="welcomeSection">
                <div class="question-section">
                    <h2>今日の学習を始めよう！</h2>
                    <p>追手門学院中学の入試に出る漢字を、楽しく学習できます。</p>
                    <ul>
                        <li>毎日10問の漢字問題に挑戦</li>
                        <li>6問以上正解で基本ポイントゲット</li>
                        <li>満点なら最大20ポイント獲得</li>
                        <li>5日連続で100円達成！</li>
                    </ul>
                    <button class="start-button" id="startButton">学習を始める</button>
                </div>
            </div>
            
            <div class="progress-sidebar">
                <h3>今日の進捗</h3>
                
                <div class="progress-item">
                    <div class="progress-label">完了した問題</div>
                    <div class="progress-value" id="completedCount">0/10</div>
                    <div class="mini-progress-bar">
                        <div class="mini-progress-fill" id="questionProgress" style="width:0%"></div>
                    </div>
                </div>
                
                <div class="progress-item">
                    <div class="progress-label">正解数</div>
                    <div class="progress-value" id="correctCount">0問</div>
                </div>
                
                <div class="progress-item">
                    <div class="progress-label">今日の獲得予定</div>
                    <div class="progress-value" id="expectedPoints">0P</div>
                </div>
                
                <div id="miniRewardStatus"></div>
            </div>
        </div>
        
        <div id="reward-system-container">
            <!-- 報酬システムUIがここに表示される -->
        </div>
    </div>
    
    <!-- スクリプト読み込み -->
    <script src="large-kanji-database.js"></script>
    <script src="option-validator.js"></script>
    <script src="reward-system.js"></script>
    <script src="reward-ui.js"></script>
    
    <script>
        // 統合学習システム
        class IntegratedStudySystem {
            constructor() {
                this.problemEngine = new DynamicProblemEngine();
                this.optionValidator = new OptionValidator();
                this.rewardSystem = new KanjiRewardSystem();
                this.rewardUI = new RewardSystemUI(this.rewardSystem);
                
                this.currentProblems = [];
                this.currentProblemIndex = 0;
                this.sessionResults = [];
                this.selectedOptionIndex = null;
                
                this.initializeSystem();
            }
            
            initializeSystem() {
                // イベントリスナー設定
                document.getElementById('startButton').addEventListener('click', () => this.startSession());
                document.getElementById('submitButton').addEventListener('click', () => this.submitAnswer());
                
                // 報酬システムUI更新
                this.rewardUI.updateDisplay();
                
                // サプライズデーチェック
                if (this.rewardSystem.checkSurpriseDay()) {
                    alert('🎉 今日はサプライズデー！ポイント2倍のチャンス！');
                }
            }
            
            startSession() {
                // 今日の問題を生成
                const today = new Date();
                this.currentProblems = this.problemEngine.generateDailyUniqueProblems(today);
                this.currentProblemIndex = 0;
                this.sessionResults = [];
                this.selectedOptionIndex = null;
                
                // UI切り替え
                document.getElementById('welcomeSection').style.display = 'none';
                document.getElementById('questionSection').style.display = 'block';
                
                // 最初の問題を表示
                this.displayProblem();
            }
            
            displayProblem() {
                const problem = this.currentProblems[this.currentProblemIndex];
                
                // 問題番号更新
                document.getElementById('questionNumber').textContent = 
                    `問題 ${this.currentProblemIndex + 1}/10`;
                
                // レベル表示
                const levelElement = document.getElementById('questionLevel');
                levelElement.textContent = `レベル${problem.level}`;
                levelElement.className = `question-level level-${problem.level}`;
                
                // 問題文表示（漢字をハイライト）
                const questionText = problem.question.replace(
                    /「(.+?)」/g, 
                    '<span class="highlight">$1</span>'
                );
                document.getElementById('questionText').innerHTML = questionText;
                
                // 選択肢を検証して表示
                const validatedOptions = this.optionValidator.validateOptions(
                    problem.options,
                    problem.correct
                );
                
                // 選択肢ボタン作成
                const optionsGrid = document.getElementById('optionsGrid');
                optionsGrid.innerHTML = '';
                
                validatedOptions.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option;
                    button.addEventListener('click', () => this.selectOption(index));
                    optionsGrid.appendChild(button);
                });
                
                // UIリセット
                document.getElementById('submitButton').disabled = true;
                document.getElementById('feedbackSection').style.display = 'none';
                this.selectedOptionIndex = null;
            }
            
            selectOption(index) {
                // 前の選択をクリア
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // 新しい選択
                document.querySelectorAll('.option-button')[index].classList.add('selected');
                this.selectedOptionIndex = index;
                document.getElementById('submitButton').disabled = false;
            }
            
            submitAnswer() {
                if (this.selectedOptionIndex === null) return;
                
                const problem = this.currentProblems[this.currentProblemIndex];
                const isCorrect = this.selectedOptionIndex === problem.correct;
                
                // 結果を記録
                this.sessionResults.push({
                    problemIndex: this.currentProblemIndex,
                    isCorrect: isCorrect,
                    kanjiWord: problem.kanjiWord,
                    level: problem.level
                });
                
                // 選択肢の色を変更
                const buttons = document.querySelectorAll('.option-button');
                buttons[this.selectedOptionIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
                buttons[problem.correct].classList.add('correct');
                
                // フィードバック表示
                const feedback = document.getElementById('feedbackSection');
                feedback.className = `feedback-section ${isCorrect ? 'correct' : 'incorrect'}`;
                feedback.innerHTML = `
                    <h3>${isCorrect ? '🎉 正解！' : '😢 残念...'}</h3>
                    <p>${problem.explanation}</p>
                    ${problem.hint ? `<p>ヒント: ${problem.hint}</p>` : ''}
                `;
                feedback.style.display = 'block';
                
                // 進捗更新
                this.updateProgress();
                
                // ボタンを変更
                const submitButton = document.getElementById('submitButton');
                if (this.currentProblemIndex < 9) {
                    submitButton.textContent = '次の問題へ';
                    submitButton.onclick = () => this.nextProblem();
                } else {
                    submitButton.textContent = '結果を見る';
                    submitButton.onclick = () => this.showResults();
                }
                submitButton.disabled = false;
            }
            
            nextProblem() {
                this.currentProblemIndex++;
                this.displayProblem();
                document.getElementById('submitButton').textContent = '答えを確認';
                document.getElementById('submitButton').onclick = () => this.submitAnswer();
            }
            
            showResults() {
                // 正解数を計算
                const correctCount = this.sessionResults.filter(r => r.isCorrect).length;
                
                // 報酬システムに記録
                const result = this.rewardSystem.recordDailyResult(new Date(), correctCount);
                
                // 結果表示
                this.rewardUI.displayTodayResult(result);
                
                // セッション終了
                this.endSession();
            }
            
            updateProgress() {
                const completed = this.currentProblemIndex + 1;
                const correct = this.sessionResults.filter(r => r.isCorrect).length;
                
                document.getElementById('completedCount').textContent = `${completed}/10`;
                document.getElementById('correctCount').textContent = `${correct}問`;
                document.getElementById('questionProgress').style.width = `${completed * 10}%`;
                
                // 予想ポイント計算
                const currentRate = correct / completed;
                const expectedCorrect = Math.round(currentRate * 10);
                const expectedPoints = this.rewardSystem.calculateDailyPoints(expectedCorrect);
                document.getElementById('expectedPoints').textContent = `${expectedPoints}P`;
            }
            
            endSession() {
                // UIをリセット
                setTimeout(() => {
                    document.getElementById('questionSection').style.display = 'none';
                    document.getElementById('welcomeSection').style.display = 'block';
                    
                    // 報酬システムUI更新
                    this.rewardUI.updateDisplay();
                }, 3000);
            }
        }
        
        // システム初期化
        const studySystem = new IntegratedStudySystem();
    </script>
</body>
</html>